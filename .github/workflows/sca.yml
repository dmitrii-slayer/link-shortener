name: Software Composition Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Generate SBOM with CycloneDX
        run: |
          mvn org.cyclonedx:cyclonedx-maven-plugin:2.8.0:makeAggregateBom \
            -DincludeCompileScope=true \
            -DincludeRuntimeScope=true \
            -DincludeProvidedScope=true \
            -DincludeSystemScope=true \
            -DincludeTestScope=false \
            -DoutputFormat=json \
            -DoutputName=bom

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: target/bom.json
          retention-days: 7

  security-analysis:
    name: Security Analysis
    runs-on: ubuntu-latest
    needs: generate-sbom
    if: github.event_name == 'pull_request' || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download SBOM artifact
        uses: actions/download-artifact@v4
        with:
          name: sbom-cyclonedx
          path: .

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        id: dependency-check
        with:
          project: '${{ github.event.repository.name }}'
          path: '.'
          format: 'HTML'
          args: >
            --enableExperimental
            --failOnCVSS 8
            --scan .
            --out reports
            --disableYarnAudit
            --disableNodeAudit
            --disableNodeJS
        continue-on-error: true

      - name: Upload Dependency-Check report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: reports/
          retention-days: 7
